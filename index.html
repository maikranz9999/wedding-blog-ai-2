<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Blog AI - Intelligenter Blog-Generator</title>
    <meta name="description" content="Erstelle professionelle Hochzeitsblogs mit KI-Unterst√ºtzung. SEO-optimiert, strukturiert und hochwertig.">
    <meta name="keywords" content="Wedding Blog, Hochzeitsblog, KI Generator, SEO, Hochzeitsplanung">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíç</text></svg>">
    
    <style>
        /* CSS bleibt gleich wie in der urspr√ºnglichen Datei - hier gek√ºrzt f√ºr √úbersichtlichkeit */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #533483 75%, #7209b7 100%);
            min-height: 100vh;
            padding: 20px;
            color: #ffffff;
            overflow-x: hidden;
            font-size: 14px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(26, 26, 46, 0.85);
            backdrop-filter: blur(15px);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
            max-height: 90vh;
        }

        /* Quota Display Styles */
        .quota-display {
            background: rgba(32, 201, 151, 0.1);
            border: 1px solid rgba(32, 201, 151, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
            display: none;
        }

        .quota-display.visible {
            display: block;
        }

        .quota-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .quota-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
        }

        .quota-label {
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quota-value {
            font-size: 16px;
            font-weight: 600;
            margin-top: 4px;
        }

        .quota-value.low {
            color: #ff6b35;
        }

        .quota-value.warning {
            color: #ffc107;
        }

        .quota-value.good {
            color: #20c997;
        }

        /* Error Display Styles */
        .error-display {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            display: none;
        }

        .error-display.visible {
            display: block;
        }

        .error-title {
            font-weight: 600;
            color: #dc3545;
            margin-bottom: 8px;
        }

        /* User Info Display */
        .user-info {
            background: rgba(114, 9, 183, 0.1);
            border: 1px solid rgba(114, 9, 183, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 24px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            display: none;
        }

        .user-info.visible {
            display: block;
        }

        /* Rest des CSS bleibt gleich... */
        /* Hier w√ºrde der komplette CSS Code aus der urspr√ºnglichen Datei stehen */
        
    </style>
</head>
<body>
    <div class="container">
        <!-- User Info Display -->
        <div class="user-info" id="userInfo">
            <span id="userInfoText">L√§dt Benutzerinformationen...</span>
        </div>

        <!-- Error Display -->
        <div class="error-display" id="errorDisplay">
            <div class="error-title" id="errorTitle">Fehler</div>
            <div id="errorMessage"></div>
        </div>

        <!-- Quota Display -->
        <div class="quota-display" id="quotaDisplay">
            <div style="font-weight: 600; color: #20c997; margin-bottom: 8px;">üìä Deine heutige Nutzung</div>
            <div class="quota-grid" id="quotaGrid">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
        </div>

        <div class="logo">
            üíç Wedding Blog AI
        </div>

        <!-- Alle anderen HTML-Elemente bleiben gleich wie in der urspr√ºnglichen Datei -->
        <!-- Hier w√ºrde der komplette HTML Inhalt aus der urspr√ºnglichen Datei stehen -->

    </div>

    <script>
        // Globale Variablen
        let currentOutline = '';
        let currentBlogPost = '';
        let isGenerating = false;
        let selectedKeywords = [];
        let currentEditingContent = null;
        let userInfo = null;
        let quotaInfo = null;

        // LearningsSuite Integration
        const LEARNINGSSUITE_CONFIG = {
            secretKey: 'your-learningssuite-secret-key', // Wird sp√§ter durch ENV ersetzt
            apiBaseUrl: '/api'
        };

        // URL Parameter aus LearningsSuite lesen
        function getLearningsSuiteParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                userId: urlParams.get('user_id'),
                userEmail: urlParams.get('user_email'),
                userName: urlParams.get('user_name'),
                firstName: urlParams.get('first_name'),
                lastName: urlParams.get('last_name')
            };
        }

        // User Authentication und Info laden
        async function initializeLearningsSuiteUser() {
            const params = getLearningsSuiteParams();
            
            if (!params.userId) {
                showError('Benutzer-Authentifizierung fehlgeschlagen', 
                    'Bitte √∂ffne das Tool √ºber LearningsSuite. Direkter Zugriff ist nicht m√∂glich.');
                return false;
            }

            // Token generieren (einfache Variante - in Production sollte das sicherer sein)
            const token = LEARNINGSSUITE_CONFIG.secretKey + params.userId;
            
            userInfo = {
                userId: params.userId,
                token: token,
                userName: params.userName || params.firstName + ' ' + params.lastName || 'Unbekannt',
                userEmail: params.userEmail || '',
                firstName: params.firstName || '',
                lastName: params.lastName || ''
            };

            // User Info anzeigen
            updateUserInfoDisplay();
            
            // Quota laden
            await loadUserQuota();
            
            return true;
        }

        // User Info Display aktualisieren
        function updateUserInfoDisplay() {
            const userInfoElement = document.getElementById('userInfo');
            const userInfoText = document.getElementById('userInfoText');
            
            if (userInfo && userInfoElement && userInfoText) {
                userInfoText.innerHTML = `üëã Hallo <strong>${userInfo.userName}</strong>! Du bist angemeldet und bereit f√ºr die Blog-Erstellung.`;
                userInfoElement.classList.add('visible');
            }
        }

        // Quota Informationen laden
        async function loadUserQuota() {
            try {
                const response = await fetch('/api/quota', {
                    method: 'GET',
                    headers: {
                        'X-User-ID': userInfo.userId,
                        'X-User-Token': userInfo.token
                    }
                });

                if (response.ok) {
                    quotaInfo = await response.json();
                    updateQuotaDisplay();
                }
            } catch (error) {
                console.error('Quota loading error:', error);
                // Nicht kritisch - Tool funktioniert auch ohne Quota-Anzeige
            }
        }

        // Quota Display aktualisieren
        function updateQuotaDisplay() {
            const quotaDisplay = document.getElementById('quotaDisplay');
            const quotaGrid = document.getElementById('quotaGrid');
            
            if (!quotaInfo || !quotaDisplay || !quotaGrid) return;

            let quotaHTML = '';
            
            // Verschiedene Request-Types anzeigen
            const types = [
                { key: 'title-optimization', label: 'Titel-Optimierung' },
                { key: 'outline-generation', label: 'Gliederung' },
                { key: 'content-generation', label: 'Content' },
                { key: 'text-improvement', label: 'Verbesserung' }
            ];

            types.forEach(type => {
                const quota = quotaInfo[type.key];
                if (quota) {
                    const percentage = (quota.used / quota.limit) * 100;
                    let statusClass = 'good';
                    if (percentage >= 90) statusClass = 'low';
                    else if (percentage >= 70) statusClass = 'warning';

                    quotaHTML += `
                        <div class="quota-item">
                            <div class="quota-label">${type.label}</div>
                            <div class="quota-value ${statusClass}">${quota.remaining}/${quota.limit}</div>
                        </div>
                    `;
                }
            });

            if (quotaHTML) {
                quotaGrid.innerHTML = quotaHTML;
                quotaDisplay.classList.add('visible');
            }
        }

        // Erweiterte callAI Funktion mit Memberspot Headers
        async function callAI(prompt, type = 'general') {
            if (!userInfo) {
                throw new Error('Benutzer nicht authentifiziert');
            }

            try {
                const response = await fetch('/api/claude', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userInfo.userId,
                        'X-User-Token': userInfo.token
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        type: type
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    // Spezielle Behandlung f√ºr Rate Limiting
                    if (data.code === 'RATE_LIMIT_EXCEEDED') {
                        const resetTime = new Date(data.resetTime);
                        const resetText = resetTime.toLocaleTimeString('de-DE');
                        
                        throw new Error(`${data.error} (Reset: ${resetText})`);
                    }
                    
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }

                // Quota nach erfolgreicher Anfrage aktualisieren
                if (data.quota) {
                    quotaInfo = { ...quotaInfo, [type]: data.quota };
                    updateQuotaDisplay();
                }

                return data.content;

            } catch (error) {
                console.error('API Error:', error);
                throw new Error(`Fehler bei der KI-Anfrage: ${error.message}`);
            }
        }

        // Error Display Funktionen
        function showError(title, message) {
            const errorDisplay = document.getElementById('errorDisplay');
            const errorTitle = document.getElementById('errorTitle');
            const errorMessage = document.getElementById('errorMessage');
            
            if (errorDisplay && errorTitle && errorMessage) {
                errorTitle.textContent = title;
                errorMessage.textContent = message;
                errorDisplay.classList.add('visible');
            }
        }

        function hideError() {
            const errorDisplay = document.getElementById('errorDisplay');
            if (errorDisplay) {
                errorDisplay.classList.remove('visible');
            }
        }

        // Alle anderen Funktionen bleiben gleich wie in der urspr√ºnglichen Datei
        // Hier w√ºrde der komplette JavaScript Code aus der urspr√ºnglichen Datei stehen

        // Initialisierung mit LearningsSuite Integration
        document.addEventListener('DOMContentLoaded', async function() {
            // Zuerst LearningsSuite User initialisieren
            const userInitialized = await initializeLearningsSuiteUser();
            
            if (!userInitialized) {
                // Stoppe weitere Initialisierung wenn User nicht authentifiziert
                return;
            }

            // Verstecke Error-Display falls sichtbar
            hideError();
            
            // Normale Initialisierung fortsetzen
            initKeywordTagSystem();
            setupTextareaAutoResize();
            updateKeywordCounter();
            addInitialBlockInserter();
            
            setTimeout(() => {
                showStatusMessage("üéØ <strong>Wedding Blog AI ist bereit!</strong><br><br>Du bist erfolgreich angemeldet und kannst mit der Blog-Erstellung beginnen.<br><br>üí° <em>Tipp: Behalte deine Nutzungsquote im Blick und nutze aussagekr√§ftige Keywords f√ºr bessere SEO-Ergebnisse!</em>");
            }, 1000);

            // Event Listeners
            const titleInput = document.getElementById('blogTitle');
            if (titleInput) {
                titleInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        optimizeTitle();
                    }
                });
            }

            // Popup Event Listeners
            const overlay = document.getElementById('chatPopupOverlay');
            if (overlay) {
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        closeChatPopup();
                    }
                });
            }

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const popup = document.getElementById('chatPopupOverlay');
                    if (popup && popup.classList.contains('visible')) {
                        closeChatPopup();
                    }
                }
            });
        });

        // Periodisches Quota-Update (alle 5 Minuten)
        setInterval(async () => {
            if (userInfo) {
                await loadUserQuota();
            }
        }, 5 * 60 * 1000);

    </script>
</body>
</html>
